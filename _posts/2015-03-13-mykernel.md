---
layout: post
title: "多进程时间片轮转"
quote:
image: false
video: false
---
>此文仅用于MOOC`Linux内核分析`作业

>**张依依**+原创作品转载请注明出处 + 《Linux内核分析》**MOOC课程**http://mooc.study.163.com/course/USTC-1000029000

#以下为正文

##1.运行精简的操作系统内核

{% include image.html url="/media/2015-3-13/kernel1.png" width="100%" description="通过qemu -kernel arch/x86/boot/bzImage实现" %}

##2.时间片轮转多道程序

直接使用[mykernel](https://github.com/mengning/mykernel)上的精简算法调度的代码。
替换原本的`mymain.c`和`myinterrupt.c`，加入头文件`mypcb.h`重新编译内核。

{% include image.html url="/media/2015-3-13/make.png" width="100%"  %}

通过`qemu -kernel arch/x86/boot/bzImage`运行的结果：

{% include image.html url="/media/2015-3-13/dispatch0.png" width="100%"  %}

{% include image.html url="/media/2015-3-13/dispatch1.png" width="100%"  %}

##分析代码

###进程的启动

初始化：

```c

void __init my_start_kernel(void)
{
    int pid = 0;
    int i;
    /* Initialize process 0*/
    task[pid].pid = pid;
    task[pid].state = 0;/* -1 unrunnable, 0 runnable, >0 stopped */
    task[pid].task_entry = task[pid].thread.ip = (unsigned long)my_process;
    task[pid].thread.sp = (unsigned long)&task[pid].stack[KERNEL_STACK_SIZE-1];
    task[pid].next = &task[pid];
    /*fork more process */
    for(i=1;i<MAX_TASK_NUM;i++)
    {
        memcpy(&task[i],&task[0],sizeof(tPCB));
        task[i].pid = i;
        task[i].state = -1;
        task[i].thread.sp = (unsigned long)&task[i].stack[KERNEL_STACK_SIZE-1];
        task[i].next = task[i-1].next;
        task[i-1].next = &task[i];
    }
    /* start process 0 by task[0] */
    pid = 0;
    my_current_task = &task[pid];
	asm volatile(
    	"movl %1,%%esp\n\t" 	/* set task[pid].thread.sp to esp */
    	"pushl %1\n\t" 	        /* push ebp */
    	"pushl %0\n\t" 	        /* push task[pid].thread.ip */
    	"ret\n\t" 	            /* pop task[pid].thread.ip to eip */
    	"popl %%ebp\n\t"
    	:
    	: "c" (task[pid].thread.ip),"d" (task[pid].thread.sp)	/* input c or d mean %ecx/%edx*/
	);
}

```

初始化pid为0的进程，在for循环中初始化1~3的进程。
`task[i].next = task[i-1].next;
task[i-1].next = &task[i];`语句实际上是创建一个循环的链表。
